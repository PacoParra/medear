<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Grupo MEDEA" />

<meta name="date" content="2018-01-15" />

<title>Protocolo de georreferenciación</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Protocolo de georreferenciación</h1>
<h4 class="author"><em>Grupo MEDEA</em></h4>
<h4 class="date"><em>2018-01-15</em></h4>



<p>El protocolo según se ha definido consta de 3 partes separadas:</p>
<ul>
<li>Importación de las librerias, datos y adaptación de su formato para la geocodificación.</li>
<li>Geocodificación con <code>caRtociudad</code>.</li>
<li>Geocodificación de registros restantes con <code>Google</code>.</li>
</ul>
<p>El que el protocolo contemple dos servicios de geocodificación distintos se debe a que ambos son completamente indpendientes y por tanto una dirección que no pueda ser resuelta por uno de los servicios sí podría serlo perfectamente por el otro. En nuestra experiencia el servicio de geocodoficación de <code>Cartociudad</code> resulta más fiable que el de <code>Google</code>. Según hemos podido comprobar <code>Google</code> parece bastante más aventurado a la hora de asignar cada dirección al punto que él considera oportuno. Además, las coordenadas geográficas de las direcciones de <code>Google</code> son bastante menos precisas que las de <code>Cartociudad</code>, con bastante más error alrededor del punto que debería haber sido asignado. Sin embargo el servicio de <code>Google</code> tiene una ventaja respecto al de <code>Cartociudad</code> y es que es capaz de geocodificar puntos de interés además de direccciones por lo que es capaz de resolver direcciones del tipo <code>Residencia Costablanca, Alicante</code>. Por tanto el servicio de <code>Google</code> aporta un matiz complementario que <code>Cartociudad</code> no es capaz de ofrecer por lo que resulta interesante la utilización también de este servicio.</p>
<p>En consecuencia el protocolo de geocodificación procede de la siguiente manera. En primer lugar todas las direcciones intentan ser geocodificadas mediante el servicio de <code>Cartociudad</code> ya que éste parece ser más fiable y no tiene limitación diaria en cuanto al número de direcciones a geocodificar. Una vez terminado ese proceso, en el que nos habremos quitado de encima buena parte de las direcciones que teníamos que geocodificar, intentaremos la geocodificación de las direcciones restantes mediante el servicio de <code>Google</code>. En adelante describimos en detalle cada una de estas fases del protocolo.</p>
<section id="importacion-de-las-librerias-datos-y-adaptacion-de-su-formato-para-la-geocodificacion" class="level1">
<h1><span class="header-section-number">1</span> Importación de las librerias, datos y adaptación de su formato para la geocodificación</h1>
<section id="carga-de-las-librerias-necesarias-para-el-proceso-de-geocodificacion" class="level2">
<h2><span class="header-section-number">1.1</span> Carga de las librerias necesarias para el proceso de geocodificación:</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="cf">if</span> (<span class="op">!</span><span class="st">&quot;devtools&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">installed.packages</span>()) </a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="kw">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;fisabio/medear&quot;</span>) <span class="co"># Puede tardar unos minutos...</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">library</span>(medear)</a></code></pre></div>
<p>Al instalar el paquete <code>medear</code> se instalan las dependencias, que incluyen a los paquetes <code>ggmap</code> y <code>caRtociudad</code>. Se ha testado el uso de esto protocolo con las siguientes versiones de los paquetes:</p>
<ul>
<li><code>devtools</code>: Versión 1.13.4</li>
<li><code>medear</code>: Versión 0.2.1</li>
<li><code>ggmap</code>: Versión 2.6.1</li>
<li><code>caRtociudad</code>: Versión 0.5.5</li>
</ul>
</section>
<section id="carga-y-preparacion-de-la-cartografia" class="level2">
<h2><span class="header-section-number">1.2</span> Carga y preparación de la cartografía</h2>
<p>El proceso de geocodificación hace uso de la cartografía de cada municipio para chequear que cada una de las geocodificaciones realizadas cae dentro del límite territorial de la ciudad correspondiente. En caso contrario la geocodificación realizada es desechada por considerarse errónea al suponer que la dirección se ha asignado a otro municipio.</p>
<p>Al haber cargado la librería <code>medear</code> dispondremos de una cartografía (descargado de la web del INE) a nivel de sección censal para el año 2011 parar todas las ciudades del proyecto MEDEA. Dicha cartografía se encuentra en el objeto <code>cartografia</code>. El <code>data.frame</code> asociado a <code>cartografia</code> tiene como columnas: <code>seccion</code>, <code>CUMUN</code> (código INE para cada municipio), <code>CCA</code> (código INE para cada comunidad autónoma), y las variables <code>NPRO</code>, <code>NCA</code> y <code>NMUN</code>, que hacen referencia a los nombres estandarizados de cada provincia, comunidad autónoma y municipio (respectivamente).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Filtramos la cartografía, en nuestro caso nos quedamos sólo con las ciudades de la </span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># Comunitat Valenciana (adaptar en caso de otras CCAA)</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">carto.munis &lt;-<span class="st"> </span>cartografia[cartografia<span class="op">$</span>CCA <span class="op">==</span><span class="st"> &quot;10&quot;</span>, ]</a></code></pre></div>
<p>En caso de que quisiéramos cargar otra cartografía que no fuera la incluida en el paquete <code>medear</code> podríamos hacerlo. Si la cartografía estuviera en formato <em>ESRI Shapefile</em> (archivo con extensión <code>.shp</code>) sería necesario que dicho archivo lleve anexo un archivo con la proyección empleada (archivo con extensión <code>.prj</code>) con el mismo nombre que el archivo con la cartografía. Como decíamos, el archivo con extensión <code>.prj</code> contendrá la información sobre la proyección utilizada para georeferenciar la cartografía y por tanto para referenciar sus elementos exactamente dentro del globo terráqueo. Esta información resulta necesaria para ciertas fases del proceso de geocodificación.</p>
<p>En caso de querer cargar un archivo de cartografía lo podremos hacer de la siguiente manera:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># No ejecutar este comando a menos que se quiera importar un archivo de cartografía</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co"># El paquete rgdal se instala como dependencia del paquete medear</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">library</span>(rgdal)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># Cambiar CartografiaDeseada.shp y XXXXXXXX por los argumentos oportunos</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">carto.munis &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn =</span> <span class="st">&quot;CartografiaDeseada.shp&quot;</span>, <span class="dt">layer =</span> <span class="st">&quot;CartografiaDeseada&quot;</span>)</a></code></pre></div>
</section>
<section id="carga-y-preparacion-de-los-datos-de-mortalidad" class="level2">
<h2><span class="header-section-number">1.3</span> Carga y preparación de los datos de mortalidad</h2>
<p>En esta sección vamos a cargar la información de mortalidad, con sus direcciones, que nos disponemos a geocodificar. Los datos de la Comunidad Valenciana se encuentran en un objeto de <code>R</code> llamado <code>datosmort</code>. El objeto <code>datosmort</code> típicamente se cargara mediante alguna sentencia del tipo <code>load(...)</code> o <code>read.csv(...)</code> donde <code>...</code> contendrá la ruta en la que tengamos el archivo correspondiente y si acaso algún otro argumento específico de dicha lectura. Si deseas ejecutar este protocolo de forma secuencial sin cambiar nada, es importante que, una vez hayas leído tus datos en <code>R</code> uses el mismo nombre que nosotros (<code>datosmort</code>). Esto puedes hacerlo con la sentencia: <code>datosmort &lt;- tu_data.frame_con_tu_mortalidad</code>.</p>
<p>En el caso de la Comunidad Valenciana el data.frame con la mortalidad tiene la siguiente estructura:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">colnames</span>(datosmort)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co"># [1] &quot;NID&quot;        &quot;SEXO&quot;       &quot;ANODEFUN&quot;   &quot;MESDEFUN&quot;   &quot;DIADEFUN&quot;   &quot;ANONAC&quot;    </span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co"># [7] &quot;MESNAC&quot;     &quot;DIANAC&quot;     &quot;TVIA&quot;       &quot;NVIA&quot;       &quot;NPOLI&quot;      &quot;CODMUNIRES&quot;</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co"># [13]&quot;NMUNIRES&quot;   &quot;NPROVRES&quot;   &quot;CODPST&quot;      &quot;CAUSABASIC&quot;</span></a></code></pre></div>
<p>De esos campos los únicos que vamos a utilizar de aquí en adelante son: * <code>TVIA</code>, tipo de vía. * <code>NVIA</code>, nombre de la vía. * <code>NPOLI</code>, número de policia del domicilio. * <code>CODMUNIRES</code>, código INE del municipio. * <code>NMUNIRES</code>, nombre del municipio de residencia. * <code>NPROVRES</code>, nombre de la provincia de residencia. * <code>CODPST</code>, código postal (si se tiene, si no contendrá un texto en blanco: “”).</p>
<p>Para que el resto de instrucciones contenidas en este protocolo funcionen sin ninguna modificación adicional, tu <code>data.frame</code> con la información de mortalidad habrá de tener (al menos) estos campos con exactamente estos nombres. Si los nombres de estas columnas en tu <code>data.frame</code> fueran distintos te aconsejamos que los renombres. Respecto al resto de columnas, si alguna faltara, tuvieras alguna de más o con distinto nombre, dado que no van a necesitarse no tendrá ninguna importancia para el correcto funcionamiento del protocolo.</p>
<p>Una vez que te hayas asegurado que tu <code>data.frame</code> tenga la información que acabamos de comentar, con ese formato exactamente, las siguientes sentencias modifican dicho <code>data.frame</code> inicializando las columnas que serán rellenadas posteriormente en el proceso de geocodificación</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">datosmort<span class="op">$</span>BOD.direccion &lt;-<span class="st"> &quot;&quot;</span>    <span class="co"># Dirección tal cual ha sido intentada geocodificar</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">datosmort<span class="op">$</span>georef        &lt;-<span class="st"> &quot;NO&quot;</span>  <span class="co"># Status del proceso de georeferenciación</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">datosmort<span class="op">$</span>id            &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">datosmort<span class="op">$</span>province      &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">datosmort<span class="op">$</span>muni          &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">datosmort<span class="op">$</span>tip_via       &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">datosmort<span class="op">$</span>address       &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">datosmort<span class="op">$</span>portalNumber  &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">datosmort<span class="op">$</span>refCatastral  &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">datosmort<span class="op">$</span>postalCode    &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">datosmort<span class="op">$</span>lat           &lt;-<span class="st"> </span><span class="ot">NA_real_</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">datosmort<span class="op">$</span>lng           &lt;-<span class="st"> </span><span class="ot">NA_real_</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">datosmort<span class="op">$</span>stateMsg      &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">datosmort<span class="op">$</span>state         &lt;-<span class="st"> &quot;&quot;</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">datosmort<span class="op">$</span>type          &lt;-<span class="st"> &quot;&quot;</span></a></code></pre></div>
</section>
</section>
<section id="georeferenciacion-con-cartociudad" class="level1">
<h1><span class="header-section-number">2</span> Georeferenciación con caRtociudad</h1>
<p>Una vez disponemos de la base de datos de mortalidad en el formato adecuado pasamos a intentar geocodificar todas las direcciones utilizando el paquete <code>caRtociudad</code>. Para ello haremos un uso intensivo de la función <code>geocodificar_cartociudad</code> de <code>medear</code>, la cual intenta geocodificar cada dirección atendiendo a las dos versiones de <code>caRtociudad</code> disponibles a día de hoy. Para más información del funcionamiento interno de dicha función se puede recurrir a la ayuda específica de la misma (<code>?geocodificar_cartociudad</code>). Además, en caso de que una dirección no pueda ser geocodificada se prueba si distintas variantes de la dirección pudieran dar algún resultado positivo. Las variantes contempladas son 2:</p>
<ul>
<li>Filtro 1: Comprueba la duplicidadad del tipo de vía y la elimina si existe. Por ejemplo: <code>&quot;CALLE AVDA&quot; -&gt; &quot;AVDA&quot;, &quot;CALLE PLAZA&quot; -&gt; &quot;PLAZA&quot;, ...</code></li>
<li>Filtro 2: Elimina texto o bien contenido entre paréntesis o bien posterior a expresiones que contengan “URBANIZACIÓN xxxxx”, “URB xxxxxx”, “RESIDENCIA XXXXX”, “RESID XXXXX” ¿¿¿¿¿¿¿SOLO ESTO O ALGO MAS, POR MARCAR CON PUNTOS SUSPENSIVOS???</li>
</ul>
<p>El paquete <code>caRtociudad</code> manda al servicio de geocodificación las direcciones de las defunciones una a una. En caso de que la geocodificación llevada a cabo sea exitosa, completaremos los campos que hemos añadido a <code>datosmort</code> con la información que hayamos obtenido. En caso contrario simplemente actualizaremos el campo <code>georef</code> con información que podría ser de interés en relación al motivo por el que dicha defunción no ha podido ser georeferenciada.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Seleccionamos individuos a georeferenciar, si se quisiera hacer una segunda </span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># ronda de geocodificación (como luego haremos con Google) una sentencia de selección </span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co"># de este tipo hará que sólo se aplique la nueva geocodificación a los registros </span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co"># que nos parezca oportuno.</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">no.geo    &lt;-<span class="st"> </span><span class="kw">which</span>(datosmort<span class="op">$</span>georef <span class="op">==</span><span class="st"> &quot;NO&quot;</span>) </a>
<a class="sourceLine" id="cb6-7" data-line-number="7">totno.geo &lt;-<span class="st"> </span><span class="kw">length</span>(no.geo)</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co"># Comenzamos bucle de geocodificación para los registros seleccionados</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>totno.geo) {</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb6-12" data-line-number="12">  cont &lt;-<span class="st"> </span>no.geo[i]</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb6-14" data-line-number="14">  <span class="co"># Preparamos la dirección (normalización y limpieza)</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">  aux.direc &lt;-<span class="st"> </span><span class="kw">limpia_dir</span>(</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="dt">tvia    =</span> datosmort<span class="op">$</span>TVIA[cont],</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="dt">nvia    =</span> datosmort<span class="op">$</span>NVIA[cont],</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">    <span class="dt">npoli   =</span> datosmort<span class="op">$</span>NPOLI[cont],</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">    <span class="dt">muni    =</span> datosmort<span class="op">$</span>NMUNIRES[cont],</a>
<a class="sourceLine" id="cb6-20" data-line-number="20">    <span class="dt">prov    =</span> datosmort<span class="op">$</span>NPROVRES[cont],</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">    <span class="dt">codpost =</span> datosmort<span class="op">$</span>CODPST[cont]</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">  )</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"></a>
<a class="sourceLine" id="cb6-24" data-line-number="24">  <span class="cf">if</span> (aux.direc<span class="op">$</span>nvia <span class="op">==</span><span class="st"> &quot;&quot;</span>) {</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">    datosmort<span class="op">$</span>georef[cont] &lt;-<span class="st"> &quot;DIREC VACIA&quot;</span></a>
<a class="sourceLine" id="cb6-26" data-line-number="26">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">    </a>
<a class="sourceLine" id="cb6-28" data-line-number="28">    <span class="co"># Guardamos en &quot;BOD.direccion&quot; la dirección normalizada que vamos </span></a>
<a class="sourceLine" id="cb6-29" data-line-number="29">    <span class="co"># a mandar a Cartociudad.</span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30">    datosmort<span class="op">$</span>BOD.direccion[cont] &lt;-<span class="st"> </span><span class="kw">paste0</span>(</a>
<a class="sourceLine" id="cb6-31" data-line-number="31">      aux.direc<span class="op">$</span>tvia, <span class="st">&quot; &quot;</span>,</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">      aux.direc<span class="op">$</span>nvia, <span class="st">&quot; &quot;</span>,</a>
<a class="sourceLine" id="cb6-33" data-line-number="33">      aux.direc<span class="op">$</span>npoli, <span class="st">&quot;, &quot;</span>,</a>
<a class="sourceLine" id="cb6-34" data-line-number="34">      aux.direc<span class="op">$</span>muni, <span class="st">&quot; , &quot;</span>,</a>
<a class="sourceLine" id="cb6-35" data-line-number="35">      aux.direc<span class="op">$</span>prov, <span class="st">&quot; , &quot;</span>,</a>
<a class="sourceLine" id="cb6-36" data-line-number="36">      aux.direc<span class="op">$</span>codpost</a>
<a class="sourceLine" id="cb6-37" data-line-number="37">    )</a>
<a class="sourceLine" id="cb6-38" data-line-number="38">    </a>
<a class="sourceLine" id="cb6-39" data-line-number="39">    direc &lt;-<span class="st"> </span>datosmort<span class="op">$</span>BOD.direccion[cont]</a>
<a class="sourceLine" id="cb6-40" data-line-number="40">    </a>
<a class="sourceLine" id="cb6-41" data-line-number="41">    <span class="co"># Georeferenciación con caRtociudad con comprobación de que la </span></a>
<a class="sourceLine" id="cb6-42" data-line-number="42">    <span class="co"># geocodificación que hemos obtenido recae geográficamente dentro del </span></a>
<a class="sourceLine" id="cb6-43" data-line-number="43">    <span class="co"># límite geográfico correspondiente a la ciudad.</span></a>
<a class="sourceLine" id="cb6-44" data-line-number="44">    aux &lt;-<span class="st"> </span><span class="kw">geocodificar_cartociudad</span>(</a>
<a class="sourceLine" id="cb6-45" data-line-number="45">      <span class="dt">direc    =</span> direc,</a>
<a class="sourceLine" id="cb6-46" data-line-number="46">      <span class="dt">poligono =</span> carto.munis[carto.munis<span class="op">$</span>CUMUN <span class="op">==</span><span class="st"> </span>datosmort<span class="op">$</span>CODMUNIRES[cont], ]</a>
<a class="sourceLine" id="cb6-47" data-line-number="47">    )</a>
<a class="sourceLine" id="cb6-48" data-line-number="48">    </a>
<a class="sourceLine" id="cb6-49" data-line-number="49">    <span class="co"># En caso de que quisiéramos georeferenciar con caRtociudad sin más, </span></a>
<a class="sourceLine" id="cb6-50" data-line-number="50">    <span class="co"># sin comprobar que el punto que obtenemos está incluido en una región </span></a>
<a class="sourceLine" id="cb6-51" data-line-number="51">    <span class="co"># geográfica concreta podríamos hacer simplemente: </span></a>
<a class="sourceLine" id="cb6-52" data-line-number="52">    <span class="co"># aux &lt;- geocodificar_cartociudad(direc = direc)</span></a>
<a class="sourceLine" id="cb6-53" data-line-number="53">    </a>
<a class="sourceLine" id="cb6-54" data-line-number="54">    columnas_elegidas &lt;-<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb6-55" data-line-number="55">      <span class="st">&quot;id&quot;</span>, <span class="st">&quot;province&quot;</span>, <span class="st">&quot;muni&quot;</span>, <span class="st">&quot;tip_via&quot;</span>, <span class="st">&quot;address&quot;</span>, <span class="st">&quot;portalNumber&quot;</span>, <span class="st">&quot;refCatastral&quot;</span>,</a>
<a class="sourceLine" id="cb6-56" data-line-number="56">      <span class="st">&quot;postalCode&quot;</span>, <span class="st">&quot;lat&quot;</span>, <span class="st">&quot;lng&quot;</span>, <span class="st">&quot;stateMsg&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;type&quot;</span>, <span class="st">&quot;georef&quot;</span></a>
<a class="sourceLine" id="cb6-57" data-line-number="57">    )</a>
<a class="sourceLine" id="cb6-58" data-line-number="58">    </a>
<a class="sourceLine" id="cb6-59" data-line-number="59">    <span class="cf">if</span> (<span class="kw">substr</span>(aux<span class="op">$</span>georef, <span class="dv">1</span>, <span class="dv">2</span>) <span class="op">!=</span><span class="st"> &quot;NO&quot;</span>) {</a>
<a class="sourceLine" id="cb6-60" data-line-number="60">      datosmort[cont, columnas_elegidas] &lt;-<span class="st"> </span>aux</a>
<a class="sourceLine" id="cb6-61" data-line-number="61">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb6-62" data-line-number="62">      datosmort<span class="op">$</span>georef[cont] &lt;-<span class="st"> </span><span class="kw">as.character</span>(aux<span class="op">$</span>georef)</a>
<a class="sourceLine" id="cb6-63" data-line-number="63">      <span class="co"># El resultado de la geocodificación puede ser NO.XXX además de un simple NO </span></a>
<a class="sourceLine" id="cb6-64" data-line-number="64">      <span class="co"># (donde XXX nos puede aportar información adicional), ese es el motivo por </span></a>
<a class="sourceLine" id="cb6-65" data-line-number="65">      <span class="co"># el que actualizamos el valor de la columna georef del registro correspondiente. </span></a>
<a class="sourceLine" id="cb6-66" data-line-number="66">      </a>
<a class="sourceLine" id="cb6-67" data-line-number="67">      <span class="co"># En caso de que la geocodificación de la dirección no haya tenido éxito,</span></a>
<a class="sourceLine" id="cb6-68" data-line-number="68">      <span class="co">#  probamos la geocodificación de algunas variantes de dicha dirección.</span></a>
<a class="sourceLine" id="cb6-69" data-line-number="69">      <span class="cf">for</span> (filtro <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>) {</a>
<a class="sourceLine" id="cb6-70" data-line-number="70">        <span class="cf">if</span> (<span class="kw">substr</span>(aux<span class="op">$</span>georef, <span class="dv">1</span>, <span class="dv">2</span>) <span class="op">==</span><span class="st"> &quot;NO&quot;</span>) { </a>
<a class="sourceLine" id="cb6-71" data-line-number="71">          <span class="co"># Si alguno de los filtros ha funcionado no se reintentaría la geocodificación.</span></a>
<a class="sourceLine" id="cb6-72" data-line-number="72">          aux.direcf &lt;-<span class="st"> </span><span class="kw">filtra_dir</span>(<span class="dt">vias =</span> aux.direc, filtro)</a>
<a class="sourceLine" id="cb6-73" data-line-number="73">          <span class="cf">if</span> (aux.direcf <span class="op">!=</span><span class="st"> &quot;&quot;</span>) {</a>
<a class="sourceLine" id="cb6-74" data-line-number="74">              direcf &lt;-<span class="st"> </span>aux.direcf</a>
<a class="sourceLine" id="cb6-75" data-line-number="75">              aux    &lt;-<span class="st"> </span><span class="kw">geocodificar_cartociudad</span>(</a>
<a class="sourceLine" id="cb6-76" data-line-number="76">                <span class="dt">direc    =</span> direcf,</a>
<a class="sourceLine" id="cb6-77" data-line-number="77">                <span class="dt">poligono =</span> carto.munis[carto.munis<span class="op">$</span>CUMUN <span class="op">==</span><span class="st"> </span>datosmort<span class="op">$</span>CODMUNIRES[cont], ]</a>
<a class="sourceLine" id="cb6-78" data-line-number="78">              )</a>
<a class="sourceLine" id="cb6-79" data-line-number="79">          }</a>
<a class="sourceLine" id="cb6-80" data-line-number="80">          <span class="cf">if</span>(<span class="kw">substr</span>(aux<span class="op">$</span>georef, <span class="dv">1</span>, <span class="dv">2</span>) <span class="op">!=</span><span class="st"> &quot;NO&quot;</span>) {</a>
<a class="sourceLine" id="cb6-81" data-line-number="81">            datosmort[cont, columnas_elegidas] &lt;-<span class="st"> </span>aux</a>
<a class="sourceLine" id="cb6-82" data-line-number="82">            datosmort<span class="op">$</span>georef[cont] &lt;-<span class="st"> </span><span class="kw">paste0</span>(datosmort<span class="op">$</span>georef[cont], filtro)</a>
<a class="sourceLine" id="cb6-83" data-line-number="83">          }</a>
<a class="sourceLine" id="cb6-84" data-line-number="84">        }</a>
<a class="sourceLine" id="cb6-85" data-line-number="85">      }</a>
<a class="sourceLine" id="cb6-86" data-line-number="86">    }</a>
<a class="sourceLine" id="cb6-87" data-line-number="87">  }</a>
<a class="sourceLine" id="cb6-88" data-line-number="88">  <span class="co">#Contador</span></a>
<a class="sourceLine" id="cb6-89" data-line-number="89">  <span class="kw">cat</span>(<span class="kw">paste</span>(i, <span class="st">&quot;de&quot;</span>, totno.geo, <span class="st">&quot;georef&quot;</span>, datosmort<span class="op">$</span>georef[cont], <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</a>
<a class="sourceLine" id="cb6-90" data-line-number="90">}</a>
<a class="sourceLine" id="cb6-91" data-line-number="91"></a>
<a class="sourceLine" id="cb6-92" data-line-number="92"><span class="co"># Una vez finalizado el proceso guardamos una copia de los datos georeferenciados por </span></a>
<a class="sourceLine" id="cb6-93" data-line-number="93"><span class="co"># caRtociudad antes de pasar a google</span></a>
<a class="sourceLine" id="cb6-94" data-line-number="94"><span class="kw">save</span>(datosmort, <span class="dt">file =</span> <span class="st">&quot;datos/datosfinalescarto/datoscarto.RData&quot;</span>)</a></code></pre></div>
</section>
<section id="georeferenciacion-con-google" class="level1">
<h1><span class="header-section-number">3</span> Georeferenciación con Google</h1>
<p>Una vez hemos concluido el procedimiento de geocodificación de <code>caRtociudad</code> querremos utilizar el servicio de geocodificación de <code>Google</code> para tratar de georeferenciar todos los registros que no hayan podido ser georeferenciados con <code>caRtociudad</code>. Además, en ocasiones también querremos regeocodificar algunas direcciones que ya hayamos mandado a <code>Google</code> en caso de que anteriormente no hubieran sido geocodifcados por <code>Google</code> por haber excedido el número máximo diario de georeferenciaciones posibles de esta herramienta o por fallos de conexión que pudiera haber en la red. Para entender mejor el código que se muestra a continuación debemos tener en cuenta que al tratar de georeferenciar con <code>Google</code> un registro la respuesta puede ser la siguiente:</p>
<ul>
<li><code>state</code> igual a <code>&quot;OK&quot;</code> : registro georeferenciado.</li>
<li><code>state</code> distinto de <code>&quot;OK&quot;</code>:
<ul>
<li><code>state</code> igual a <code>&quot;ZERO_RESULTS&quot;</code> indica que el registro no ha podido ser georeferenciado por google.</li>
<li><code>state</code> igual a <code>&quot;OVER_QUERY_LIMIT&quot;</code> indica que por algún motivo (puede ser exceso de número de georeferenciaciones diarias, o fallo de la red o el servidor de <code>Google</code> en un momento determinado, u otro motivo similar, la dirección no ha podido ser georeferenciada. Estas direcciones son susceptibles de volver a ser enviadas a <code>Google</code> para ser geocodificadas de nuevo.</li>
</ul></li>
</ul>
<p>Por este motivo, cuando tratamos de geocodificar con <code>Google</code> y no tenemos éxito (<code>state != &quot;OK&quot;</code>), nos vamos a guardar además del campo <code>georef == &quot;NO&quot;</code> el valor de <code>state</code> con el fin de volver a enviar aquellas direcciones que sea necesario en una reejecución posterior de esta parte del protocolo.</p>
<p>El servicio de geocodificacion de <code>Google</code>, a diferencia del de <code>Cartociudad</code> tiene un límite en el número de geocodificaciones diarias. Dado este límite es posible que esta parte del protocolo deba ser ejecutada dividida en distintos días. Por este motivo nos interesa seleccionar los individuos cuyo estado de la variable <code>georef</code> sea <code>&quot;NO&quot;</code>, <code>&quot;NO punto...&quot;</code>, o cualquier estado que indique que el individuo no está georeferenciado. Sin embargo, debido al fallo en las georeferenciaciones que se produce en <code>Google</code> en muchas ocasiones, es importante distinguir entre los distintos tipos de individuos no georeferenciados:</p>
<ol type="1">
<li>Enviados a <code>Google</code> con éxito y que no han podido ser georeferenciados: estos registros mantendrán un valor de la variable <code>georef</code> que empieza por <code>&quot;NO&quot;</code> y un valor en <code>state</code> que indica <code>&quot;ZERO_RESULTS&quot;</code>. <em>Estos puntos NO deben volver a ser enviados a <code>Google</code> en una nueva ronda de geocodificación</em>, en caso de volver a ser mandados el resultado que obtendremos será exactamente el mismo.</li>
<li>Enviados a <code>Google</code> con éxito, georeferenciados, pero con resultado de un punto que no está en el polígono (límite municipal) requerido: estos registros mantendrán un valor de la variable <code>georef</code> que empieza por <code>&quot;NO&quot;</code> y un valor en <code>state</code> que indica <code>&quot;NO punto google&quot;</code>. <em>Estos puntos NO deben volver a ser enviados a <code>Google</code> en una nueva ronda de geocodificación</em>, en caso de volver a ser mandados el resultado que obtendremos será exactamente el mismo, resultado que no consideramos válido.</li>
<li>Enviados a <code>Google</code> sin éxito, debido a algún fallo del procedimiento como por ejemplo que se ha excedido el límite diario de geocodificaciones: estos registros mantendrán un valor de la variable <code>georef</code> que empieza por <code>&quot;NO&quot;</code> y un valor en <code>state</code> que indica <code>&quot;OVER_QUERY_LIMIT&quot;</code> o cualquier otra circunstancia. <em>Estos puntos SÍ deben volver a ser enviados a <code>Google</code> en una nueva ronda de geocodificación</em> ya que en esa nueva ronda la dirección en cuestión sí podría ser geocodificada.</li>
</ol>
<p>El proceso de geocodificación mediante <code>Google</code> se puede llevar a cabo mediante el siguiente código. A partir del momento que el proceso comience a devolver de forma repetida <code>&quot;OVER_QUERY_LIMIT&quot;</code> para, digamos 100 registros, podremos parar el proceso y reanudarlo desde otra máquina otro día ya que habríamos alcanzado el límite máximo diaria de geocodificaciones permitidas. En ese caso no olvides ejecutar la sentencia <code>save</code> del final del código para guardar las geocodificaciones efectuadas durante dicha jornada. Al retomar el código durante el día siguiente, las sentencias iniciales seleccionan los registros que quedan por geocodificar o hayan tenido una geocodificación defectuosa previa y sólo intenta la geocodificación de las direcciones correspondientes.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">load</span>(<span class="dt">file =</span> <span class="st">&quot;datos/datosfinalescarto/datoscarto.RData&quot;</span>)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">columnas_elegidas &lt;-<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">      <span class="st">&quot;id&quot;</span>, <span class="st">&quot;province&quot;</span>, <span class="st">&quot;muni&quot;</span>, <span class="st">&quot;tip_via&quot;</span>, <span class="st">&quot;address&quot;</span>, <span class="st">&quot;portalNumber&quot;</span>, <span class="st">&quot;refCatastral&quot;</span>,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">      <span class="st">&quot;postalCode&quot;</span>, <span class="st">&quot;lat&quot;</span>, <span class="st">&quot;lng&quot;</span>, <span class="st">&quot;stateMsg&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;type&quot;</span>, <span class="st">&quot;georef&quot;</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">    )</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co"># Seleccionamos aquellos individuos a georeferenciar que no lo hayan sido antes </span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co"># o hayan sido georeferenciados por Google de forma defectuosa.</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8">no.geo &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">substr</span>(datosmort<span class="op">$</span>georef, <span class="dv">1</span>, <span class="dv">2</span>) <span class="op">==</span><span class="st"> &quot;NO&quot;</span> <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="st">                  </span>datosmort<span class="op">$</span>state <span class="op">!=</span><span class="st"> &quot;ZERO_RESULTS&quot;</span> <span class="op">&amp;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="st">                  </span>datosmort<span class="op">$</span>georef <span class="op">!=</span><span class="st"> &quot;NO punto google&quot;</span>)  </a>
<a class="sourceLine" id="cb7-11" data-line-number="11">totno.geo &lt;-<span class="st"> </span><span class="kw">length</span>(no.geo)</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>totno.geo) {</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  cont  &lt;-<span class="st"> </span>no.geo[i]</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  </a>
<a class="sourceLine" id="cb7-16" data-line-number="16">  direc &lt;-<span class="st"> </span><span class="kw">limpiadirecGoogle</span>(datosmort<span class="op">$</span>BOD.direccion[cont]) </a>
<a class="sourceLine" id="cb7-17" data-line-number="17"></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">  <span class="co"># Georeferencia con Google con comprobación de que es asignado al interior del polígono</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">  <span class="co"># correspondiente a la ciudad.</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20">  aux &lt;-<span class="st"> </span><span class="kw">geocodificar_google</span>(</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">    <span class="dt">direc    =</span> direc,</a>
<a class="sourceLine" id="cb7-22" data-line-number="22">    <span class="dt">poligono =</span> carto.munis[carto.munis<span class="op">$</span>CUMUN <span class="op">==</span><span class="st"> </span>datosmort<span class="op">$</span>CODMUNIRES[cont], ]</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">  )</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">  </a>
<a class="sourceLine" id="cb7-25" data-line-number="25">  <span class="co"># Para georeferenciar con Google sin más, si no se quisiera cruzar </span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">  <span class="co"># con los límites geográficos de la ciudad haríamos:</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27">  <span class="co"># aux &lt;- geocodificar_google(direc)</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb7-29" data-line-number="29">  <span class="cf">if</span> (aux<span class="op">$</span>georef <span class="op">==</span><span class="st"> &quot;NO punto&quot;</span>) {</a>
<a class="sourceLine" id="cb7-30" data-line-number="30">    datosmort<span class="op">$</span>georef[cont] &lt;-<span class="st"> &quot;NO punto google&quot;</span></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">  }  </a>
<a class="sourceLine" id="cb7-32" data-line-number="32">  <span class="cf">if</span> (aux<span class="op">$</span>georef <span class="op">==</span><span class="st"> &quot;NO&quot;</span>) {<span class="co">#Cuando NO se ha podido georeferenciar con google </span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">    <span class="co">#recogemos el motivo: &quot;ZERO_RESULTS&quot;, &quot;OVER_QUERY_LIMIT&quot;,...</span></a>
<a class="sourceLine" id="cb7-34" data-line-number="34">    datosmort<span class="op">$</span>state[cont] &lt;-<span class="st"> </span><span class="kw">as.character</span>(aux<span class="op">$</span>state)</a>
<a class="sourceLine" id="cb7-35" data-line-number="35">  }  </a>
<a class="sourceLine" id="cb7-36" data-line-number="36">  <span class="cf">if</span>(<span class="op">!</span>aux<span class="op">$</span>georef <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;NO&quot;</span>, <span class="st">&quot;NO punto&quot;</span>)) {</a>
<a class="sourceLine" id="cb7-37" data-line-number="37">    datosmort[cont, columnas_elegidas] &lt;-<span class="st"> </span>aux</a>
<a class="sourceLine" id="cb7-38" data-line-number="38">  }</a>
<a class="sourceLine" id="cb7-39" data-line-number="39">  <span class="kw">cat</span>(<span class="kw">paste</span>(i, <span class="st">&quot;de&quot;</span>, totno.geo, <span class="st">&quot;georef&quot;</span>, datosmort<span class="op">$</span>georef[cont], <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>))</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">}</a>
<a class="sourceLine" id="cb7-41" data-line-number="41"></a>
<a class="sourceLine" id="cb7-42" data-line-number="42"><span class="kw">save</span>(datosmort, <span class="dt">file =</span> <span class="st">&quot;datos/datosfinalescarto/datoscarto.RData&quot;</span>)</a></code></pre></div>
</section>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
